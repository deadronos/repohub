---
post_title: "Client Image Compression for 500 KB Supabase Storage Limit"
author1: "AI Assistant"
post_slug: "des005-client-image-compression-500kb"
microsoft_alias: "n/a"
featured_image: "https://example.com/placeholder.png"
categories: ["Engineering"]
tags: ["supabase", "storage", "images", "compression", "webp", "nextjs"]
ai_note: "Generated by AI with user guidance."
summary: "Design for client-side image optimization (WebP + iterative quality/dimension search) to meet a 500 KB Supabase Storage bucket object size limit with graceful UX and server-side backstops."
post_date: "2025-12-28"
---

## Status

Implemented (2025-12-28)

## Problem

The Supabase Storage bucket for project images enforces a hard object size limit of 500 KB. Many screenshots (especially PNG) exceed this limit, causing uploads to fail.

Current behavior is not user-friendly:

- The admin form allows selecting any image size.
- Server-side upload errors may be logged and then silently ignored, resulting in projects being created/updated without the intended image.

We want to preserve the bucket enforcement while improving UX by preventing “mystery failures” and optionally auto-optimizing images so they fit under the limit.

## Goals

- Keep Supabase bucket limit as the final source of truth (still enforced).
- Prevent submitting oversized images and show a clear error message with actual sizes.
- Provide client-side “optimize to fit” behavior for oversized images:
  - Convert to WebP when possible.
  - Iteratively search quality and reduce dimensions until below target size.
- Preserve accessibility and a simple admin workflow.
- Avoid adding heavyweight dependencies (do not introduce server-side image libraries).

## Non-Goals

- Changing Supabase bucket configuration or raising limits.
- Implementing server-side image resizing/compression (Edge Functions / Sharp pipeline).
- Adding a full cropper UI (can be a follow-up enhancement).
- Multi-image uploads.

## Requirements (EARS)

1. WHEN an admin selects an image larger than 500 KB, THE SYSTEM SHALL block submission and display a clear message showing the selected image size and the maximum size.
   Acceptance: select an 800 KB image and confirm the “Save” button is disabled and the UI shows “800 KB / max 500 KB”.

2. WHEN an admin selects an image larger than 500 KB, THE SYSTEM SHALL attempt to optimize the image client-side (WebP re-encode + quality search + optional downscale) and produce a replacement file below the target size.
   Acceptance: select an oversized screenshot and confirm the optimized file is <= 480 KB and can be uploaded successfully.

3. WHEN optimization cannot produce a file below the target size within configured quality and downscale bounds, THE SYSTEM SHALL show a graceful failure message and keep submission blocked.
   Acceptance: select a worst-case image and verify the user is instructed to crop/choose a smaller screenshot.

4. WHEN an image upload fails server-side (including Supabase size rejection), THE SYSTEM SHALL return an actionable error message and MUST NOT silently create/update a project with a missing/incorrect image.
   Acceptance: force a server-side upload failure and confirm the admin form displays an error and the record is not modified unexpectedly.

## Proposed Approach

### Client-side preflight and optimization

On file selection in `components/AdminProjectForm.tsx`:

- If the file is <= 500,000 bytes:
  - Mark it as ready and allow submission.
- If the file is > 500,000 bytes:
  - Begin “Optimizing…” state.
  - Attempt compression/resize to reach `TARGET_BYTES = 480,000`.
  - If success:
    - Use the optimized file for submission (without requiring the user to re-select).
    - Display “Optimized from X → Y”.
  - If failure:
    - Keep submission disabled.
    - Display guidance (“Try cropping, smaller screenshot, or different format”).

### Optimization algorithm (browser-native, no deps)

Strategy:

- Decode image with `createImageBitmap(file)` (preferred) and draw into an offscreen canvas.
- Cap maximum dimension to `MAX_DIMENSION = 1920` on the first pass (prevents huge screenshots).
- Encode to `image/webp` via `canvas.toBlob()`:
  - Binary search quality in `[MIN_QUALITY = 0.55, MAX_QUALITY = 0.85]` to find the highest quality that fits under target bytes.
  - If WebP encoding is unsupported (`toBlob` returns null), fallback to `image/jpeg`.
- If still too large at minimum quality:
  - Reduce width/height by `SCALE_STEP = 0.9` and retry (bounded number of passes).

## Interfaces

Client utility (client-only):

```ts
export type ImageOptimizationOutcome =
  | { status: 'ready'; file: File; originalFile: File }
  | { status: 'skipped'; reason: 'no-file' | 'not-image' }
  | { status: 'failed'; reason: 'cannot-compress' | 'decode-failed' | 'encode-failed' };

export async function optimizeImageToUnderBytes(
  file: File,
  options?: Partial<ImageOptimizationOptions>,
): Promise<ImageOptimizationOutcome>;
```

Server utility:

```ts
export async function uploadProjectImage(
  supabase: SupabaseClient,
  file: File | null,
): Promise<ActionResult<string | null>>;
```

## Data Flow

```mermaid
flowchart TD
  UI[AdminProjectForm file input] -->|onChange| Preflight{> 500 KB?}
  Preflight -->|No| Ready[Use original File]
  Preflight -->|Yes| Optimize[Optimize (WebP + quality/dimension search)]
  Optimize -->|Success <= target| Ready2[Use optimized File]
  Optimize -->|Failure| Block[Show error + block submit]

  Ready --> Submit[Server Action: create/update]
  Ready2 --> Submit
  Submit --> Upload[uploadProjectImage -> Supabase Storage]
  Upload -->|Success| DB[(projects.image_url updated)]
  Upload -->|Failure| UIErr[Return ActionResult.error]
```

## Error Handling Matrix

| Scenario | Client behavior | Server behavior | User message |
| --- | --- | --- | --- |
| Selected file is not an image | Block | N/A | "Please choose an image file." |
| Selected file > 500 KB | Optimize; block submit until resolved | Backstop check | "This image is X KB. Max is 500 KB. Optimizing…" |
| Optimization succeeds | Enable submit with optimized file | Upload optimized file | "Optimized to Y KB" |
| Optimization fails | Keep blocked | N/A | "Couldn’t reduce below 500 KB. Try cropping or smaller screenshot." |
| Supabase rejects upload (size) | N/A | Return error; do not silently proceed | "Upload failed: image must be under 500 KB." |
| Supabase rejects upload (other) | N/A | Return error | "Upload failed. Please try again." |

## Validation Plan

- Unit tests:
  - Quality search helper selects highest quality under target given monotonic size behavior.
  - Formatting helper used in UI (bytes -> KB string) is correct.
- Manual:
  - Upload a small image (<500 KB): should submit unchanged.
  - Upload a large PNG screenshot: should auto-optimize and submit successfully.
  - Upload a pathological image that can’t be reduced: should block submit with guidance.
  - Simulate Supabase rejection (temporarily set target above 500 KB or upload original): ensure server returns a clear error and UI surfaces it.

## Follow-ups (Optional)

- Add an inline crop UI for screenshots (biggest size reducer with best perceived quality).
- Record/telemetry: log optimization time and failure reasons to identify common pain points.
